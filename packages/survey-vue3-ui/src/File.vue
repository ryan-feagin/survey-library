<template>
  <div :class="question.fileRootCss">
    <input
      :class="question.cssClasses.fileInput"
      v-if="!question.isReadOnly"
      tabindex="-1"
      type="file"
      :id="question.inputId"
      @change="question.doChange"
      :aria-required="question.ariaRequired"
      :aria-label="question.ariaLabel"
      :aria-invalid="question.ariaInvalid"
      :aria-describedby="question.ariaDescribedBy"
      :multiple="question.allowMultiple"
      v-bind:title="question.inputTitle"
      v-bind:accept="question.acceptedTypes"
      :capture="(question.renderCapture as any)"
    />
    <input
      v-if="question.isReadOnly"
      type="file"
      disabled
      :id="question.inputId"
      :class="question.getReadOnlyFileCss()"
      :multiple="question.allowMultiple"
      :placeholder="question.title"
      style="color: transparent"
    />
    <div
      :class="question.cssClasses.dragArea"
      @drop="question.onDrop"
      @dragover="question.onDragOver"
      @dragleave="question.onDragLeave"
      @dragenter="question.onDragEnter"
    >
      <div :class="question.getFileDecoratorCss()">
        <span :class="question.cssClasses.dragAreaPlaceholder">{{
          question.dragAreaPlaceholder
        }}</span>
        <div :class="question.cssClasses.wrapper">
          <label
            v-if="!question.isReadOnly"
            role="button"
            tabindex="0"
            :class="question.getChooseFileCss()"
            :for="question.inputId"
            v-bind:aria-label="question.chooseButtonText"
            v-key2click
          >
            <span>{{ question.chooseButtonText }}</span>
            <sv-svg-icon
              v-if="question.cssClasses.chooseFileIconId"
              :title="question.chooseButtonText"
              :iconName="question.cssClasses.chooseFileIconId"
              :size="'auto'"
            ></sv-svg-icon>
          </label>
          <span
            :class="question.cssClasses.noFileChosen"
            v-if="question.isEmpty()"
            >{{ question.noFileChosenCaption }}</span
          >
        </div>
      </div>
      <button
        type="button"
        v-if="question.showRemoveButton"
        :class="question.cssClasses.removeButton"
        @click="question.doClean"
      >
        <span>{{ question.clearButtonCaption }}</span>
        <sv-svg-icon
          v-if="question.cssClasses.removeButtonIconId"
          :iconName="question.cssClasses.removeButtonIconId"
          :size="'auto'"
          :title="question.clearButtonCaption"
        ></sv-svg-icon>
      </button>
      <div
        :class="question.cssClasses.fileList || undefined"
        v-if="!question.isEmpty()"
      >
        <span
          v-for="(val, index) in question.previewValue"
          :key="question.inputId + '_' + index"
          v-show="val && isPreviewVisible(index)"
          :class="question.cssClasses.preview"
        >
          <div
            v-if="val.name && question.cssClasses.fileSign"
            :class="question.cssClasses.fileSign"
          >
            <a
              @click="question.doDownloadFile($event, val)"
              :href="val.content"
              :title="val.name"
              :download="val.name"
              :style="{ width: question.imageWidth }"
              >{{ val.name }}</a
            >
          </div>
          <div :class="question.cssClasses.imageWrapper">
            <img
              v-if="question.canPreviewImage(val)"
              :src="val.content"
              :style="{
                height: question.imageHeight,
                width: question.imageWidth,
              }"
              alt="File preview"
            />
            <sv-svg-icon
              v-if="question.defaultImage(val)"
              :iconName="question.cssClasses.defaultImageIconId"
              :class="question.cssClasses.defaultImage"
              :size="'auto'"
            ></sv-svg-icon>
            <div
              v-if="val.name && !question.isReadOnly"
              :class="question.cssClasses.removeFileButton"
              @click="question.doRemoveFile(val)"
            >
              <span :class="question.cssClasses.removeFile">{{
                question.removeFileCaption
              }}</span>
              <sv-svg-icon
                v-if="question.cssClasses.removeFileSvgIconId"
                :title="question.removeFileCaption"
                :class="question.cssClasses.removeFileSvg"
                :iconName="question.cssClasses.removeFileSvgIconId"
                :size="'auto'"
              ></sv-svg-icon>
            </div>
          </div>
          <div
            v-if="val.name && question.cssClasses.fileSignBottom"
            :class="question.cssClasses.fileSignBottom"
          >
            <a
              @click="question.doDownloadFile($event, val)"
              :href="val.content"
              :title="val.name"
              :download="val.name"
              :style="{ width: question.imageWidth }"
              >{{ val.name }}</a
            >
          </div>
        </span>
      </div>
      <button
        type="button"
        v-if="question.showRemoveButtonBottom"
        :class="question.showRemoveButtonBottom"
        @click="question.doClean"
      >
        <span>{{ question.clearButtonCaption }}</span>
        <sv-svg-icon
          v-if="question.cssClasses.removeButtonIconId"
          :iconName="question.cssClasses.removeButtonIconId"
          :size="'auto'"
          :title="question.clearButtonCaption"
        ></sv-svg-icon>
      </button>
      <sv-action-bar
        v-if="question.mobileFileNavigatorVisible"
        :model="question.mobileFileNavigator"
      ></sv-action-bar>
    </div>
  </div>
</template>

<script lang="ts" setup>
import type { QuestionFileModel } from "survey-core";
import { useQuestion } from "./base";
import { ref } from "vue";
const props = defineProps<{ question: QuestionFileModel }>();
const root = ref(null);
useQuestion(props, root);
const isPreviewVisible = (index: any) => {
  return props.question.isPreviewVisible(index);
};
</script>
